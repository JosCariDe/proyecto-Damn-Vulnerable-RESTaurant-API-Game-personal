import time
import requests

BASE_URL = "http://localhost:8091"

# ============= DATOS DE USUARIOS =============
USERS = {
    "user1": {
        "username": "Daniel",
        "password": "123456",
        "phone_number": "312856599",
        "first_name": "Daniel",
        "last_name": "Cariaga"
    },
    "user2": {
        "username": "Brayan",
        "password": "654321",
        "phone_number": "312856377",
        "first_name": "Brayan",
        "last_name": "Martinez"
    }
}

# ============= FUNCIONES AUXILIARES =============
def slow_print(msg, delay=1.5):
    """Imprime mensaje con delay para visualizar el proceso"""
    print(msg)
    time.sleep(delay)

def separator(title=""):
    """Imprime separador visual"""
    print("\n" + "="*60)
    if title:
        print(f"  {title}")
        print("="*60)
    print()

# ============= FUNCIONES DE API =============
def register_user(user_data):
    """Registra un nuevo usuario"""
    slow_print(f"üìù Registrando usuario: {user_data['username']}")
    
    payload = {
        "username": user_data["username"],
        "password": user_data["password"],
        "phone_number": user_data["phone_number"],
        "first_name": user_data["first_name"],
        "last_name": user_data["last_name"]
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/register",
            json=payload,
            headers={"Content-Type": "application/json"}
        )
        slow_print(f"‚úÖ Respuesta [{r.status_code}]: {r.text}\n")
        return r
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return None

def get_token(username, password):
    """Obtiene token de autenticaci√≥n"""
    slow_print(f"üîë Obteniendo token para: {username}")
    
    # Seg√∫n tu curl, usa form-urlencoded
    payload = {
        "username": username,
        "password": password
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/token",
            data=payload,  # form-urlencoded usa 'data' no 'json'
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if r.status_code == 200:
            token_data = r.json()
            token = token_data.get("access_token")
            slow_print(f"‚úÖ Token obtenido: {token[:50]}...\n")
            return token
        else:
            slow_print(f"‚ùå Error [{r.status_code}]: {r.text}\n")
            return None
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return None

def get_profile(token, username):
    """Consulta el perfil del usuario"""
    slow_print(f"üë§ Consultando perfil de usuario autenticado")
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    try:
        r = requests.get(
            f"{BASE_URL}/profile",
            headers=headers
        )
        slow_print(f"‚úÖ Respuesta [{r.status_code}]:")
        slow_print(f"   {r.text}\n")
        return r
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return None

def update_profile(token, updates):
    """Actualiza el perfil del usuario"""
    slow_print(f"‚úèÔ∏è  Actualizando perfil con datos: {updates}")
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    try:
        r = requests.put(
            f"{BASE_URL}/profile",
            json=updates,
            headers=headers
        )
        slow_print(f"‚úÖ Respuesta [{r.status_code}]: {r.text}\n")
        return r
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return None

# ============= SCRIPT PRINCIPAL =============
def main():
    separator("üöÄ INICIO DE PRUEBAS API")
    
    tokens = {}
    
    # ===== PRUEBAS CON USER 1 (Daniel) =====
    separator("USUARIO 1: Daniel")
    
    # 1. Registrar User1
    register_user(USERS["user1"])
    
    # 2. Obtener token User1
    token1 = get_token(USERS["user1"]["username"], USERS["user1"]["password"])
    if token1:
        tokens["user1"] = token1
    
    # 3. Consultar perfil User1
    if token1:
        get_profile(token1, USERS["user1"]["username"])
    
    # 4. Actualizar perfil User1
    if token1:
        updates = {
            "username": "Daniel",
            "phone_number": "999888777",
            "first_name": "DanielActualizado",
            "last_name": "CariagaEditado"
        }
        update_profile(token1, updates)
        
        # Verificar cambios
        slow_print("üîç Verificando cambios en el perfil...")
        get_profile(token1, USERS["user1"]["username"])
    
    # ===== PRUEBAS CON USER 2 (Brayan) =====
    separator("USUARIO 2: Brayan")
    
    # 1. Registrar User2
    register_user(USERS["user2"])
    
    # 2. Obtener token User2
    token2 = get_token(USERS["user2"]["username"], USERS["user2"]["password"])
    if token2:
        tokens["user2"] = token2
    
    # 3. Consultar perfil User2
    if token2:
        get_profile(token2, USERS["user2"]["username"])
    
    # 4. Actualizar perfil User2
    if token2:
        updates = {
            "username": "Brayan",
            "phone_number": "111222333",
            "first_name": "BrayanModificado",
            "last_name": "MartinezEditado"
        }
        update_profile(token2, updates)
        
        # Verificar cambios
        slow_print("üîç Verificando cambios en el perfil...")
        get_profile(token2, USERS["user2"]["username"])
    
    # ===== PRUEBA CRUZADA (OPCIONAL) =====
    separator("üîÑ PRUEBA CRUZADA - User1 intenta modificar User2")
    
    if tokens.get("user1"):
        slow_print("‚ö†Ô∏è  Intentando modificar perfil de Brayan usando token de Daniel...")
        cross_update = {
            "username": "Brayan",  # Intentando modificar otro usuario
            "phone_number": "666666666",
            "first_name": "Hackeado",
            "last_name": "PorDaniel"
        }
        update_profile(tokens["user1"], cross_update)
    
    separator("‚úÖ FIN DE PRUEBAS")
    
    # Resumen de tokens
    print("\nüìã RESUMEN DE TOKENS OBTENIDOS:")
    for user, token in tokens.items():
        print(f"   {user}: {token[:50]}...")
    print()

if __name__ == "__main__":
    main()